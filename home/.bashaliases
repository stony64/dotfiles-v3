#!/usr/bin/env bash
# ------------------------------------------------------------------------------
# FILE:        .bashaliases
# VERSION:     1.9.3
# DESCRIPTION: Professional Power Aliases & Shell Functions
#              Optimized for Bash 4.0+, ShellCheck compliant, Proxmox-ready.
# AUTHOR:      Stony64
# ------------------------------------------------------------------------------

# --- 1. CORE & SICHERHEIT -----------------------------------------------------

# DER SUDO-TRICK: Erlaubt Bash, das Wort nach sudo ebenfalls auf Aliase zu prüfen.
alias sudo='sudo '

alias cp='cp -i --preserve=all'           # Interaktives Kopieren mit Metadaten
alias mv='mv -i --preserve=all'           # Interaktives Verschieben
alias rm='rm -i --preserve-root=always'   # Schutz gegen 'rm -rf /'
alias ln='ln -i -v'                       # Interaktive und geschwätzige Links
alias chown='chown --preserve-root'       # Root-Schutz für Besitzerwechsel
alias chmod='chmod --preserve-root'       # Root-Schutz für Rechteänderung
alias mkdir='mkdir -p -v'                 # Erstellt Pfad-Strukturen sofort

# --- 2. NAVIGATION ------------------------------------------------------------
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias -- -='cd -'                         # Schnell zurück zum letzten Verzeichnis
alias home='cd ~'

# --- 3. DYNAMISCHE LS-LOGIK (TOOL-AWARE) --------------------------------------

# Wir ermitteln einmalig beim Laden, welches Tool verfügbar ist.
if command -v eza >/dev/null 2>&1; then
    _ls_tool="eza"
    _ls_flags="--group-directories-first --git --icons"
    _ls_time="--time-style=long-iso"
elif command -v lsd >/dev/null 2>&1; then
    _ls_tool="lsd"
    _ls_flags="--group-dirs-first --icon always"
    _ls_time="--date=long-iso"
else
    _ls_tool="ls"
    _ls_time="--time-style=long-iso"
    if command ls --group-directories-first . >/dev/null 2>&1; then
        _ls_flags="--color=auto --group-directories-first"
    else
        _ls_flags="--color=auto"
    fi
fi

# SC2248: Wir wollen Word-Splitting für $_ls_flags explizit zulassen.
# shellcheck disable=SC2248
ls() { command "$_ls_tool" $_ls_flags "$@"; }
# shellcheck disable=SC2248
ll() { command "$_ls_tool" $_ls_flags -la $_ls_time "$@"; }
# shellcheck disable=SC2248
la() { command "$_ls_tool" $_ls_flags -lA "$@"; }
# shellcheck disable=SC2248
l()  { command "$_ls_tool" $_ls_flags -lh "$@"; }

# --- 4. SYSTEM & RESSOURCEN ---------------------------------------------------
alias df='df -hT -x tmpfs -x devtmpfs -x squashfs -x overlay'
alias du='du -h'
alias free='free -h --si'
alias uptime='uptime -p'
alias cls='clear && ls'

alias sc='systemctl'
alias jc='journalctl -n 50 --no-pager'
alias psmem='ps auxf | sort -nr -k 4 | head -15'

# --- 5. DIAGNOSE & NETZWERK ---------------------------------------------------
alias journal='journalctl -n 50 --no-pager | less -R'
alias dmesg='dmesg --color=always -H -T'
alias psg='ps auxf | grep -v grep | grep -i -e VSZ -e'
alias ports='ss -tulpn | grep LISTEN'
alias ssh='TERM=xterm-256color ssh -o ServerAliveInterval=60'

myip() {
    if command -v df_myip >/dev/null 2>&1; then
        df_myip
    else
        hostname -I | awk '{print $1}'
    fi
}

# --- 6. TEXTVERARBEITUNG ------------------------------------------------------
alias grep='grep --color=auto --binary-files=without-match'
alias fgrep='grep -F --color=auto'
alias egrep='grep -E --color=auto'
alias rgrep='grep -rni --exclude-dir={.git,node_modules}'
alias nano='nano -c'
alias less='less -R'

# --- 7. GIT POWER-SHORTCUTS ---------------------------------------------------
alias g='git'
alias st='git status'
alias co='git checkout'
alias br='git branch -v'
alias cm='git commit -m'
alias gd='git diff --stat'
alias lg="git log --graph --pretty=format:'%C(yellow)%h%Creset -%C(auto)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit -15"

# Upstream Push Logic
gpsh() {
    local branch
    branch=$(git branch --show-current)
    if ! git rev-parse --abbrev-ref --symbolic-full-name '@{u}' >/dev/null 2>&1; then
        git push --set-upstream origin "$branch"
    else
        git push
    fi
}

# --- 8. PROXMOX & STORAGE -----------------------------------------------------
alias pct='pct -logfile /tmp/pct-${USER}.log'
alias qm='qm -logfile /tmp/qm-${USER}.log'
alias zfs='zfs -p'
alias zpool='zpool -m'

zfslist() {
    local pool
    pool=$(zpool list -H -o name | head -1)
    [[ -n "$pool" ]] && zfs list -o space,name,mountpoint -r "$pool"
}

# --- 9. WARTUNG & UPDATES (Integration .bashwartung) --------------------------
if [[ -f ~/.bashwartung ]]; then
    # Täglich: Nur Paket-Updates
    alias au='sudo bash -c "source ~/.bashwartung && df_wartung_run"'
    # Monatlich: Updates + ZFS Scrub
    alias au-full='sudo bash -c "source ~/.bashwartung && df_wartung_run --full"'
fi

# --- 10. MISC & FIXES ---------------------------------------------------------
path() {
    printf "%b\n" "${PATH//:/\\n}" | column
}

alias f='find . -iname'
alias chwon='chown'
alias chmpod='chmod'

if command -v tree >/dev/null 2>&1; then
    alias tree='tree -F --dirsfirst --filelimit 50 --gitignore'
fi

tools() {
    # Korrektur SC2059: Variablen als Argumente für %s übergeben
    printf '%sFramework Tools v%s:%s\n' \
        "${DF_C_BLUE:-}" "${DF_PROJECT_VERSION:-3.6.3}" "${DF_C_RESET:-}"

    _t_row() { printf '  %-10s → %s\n' "$1" "$2"; }

    _t_row "reload"   "Shell-Konfiguration frisch einlesen"

    if [[ -x "/usr/local/bin/dctl" ]]; then
        _t_row "dctl" "Dotfiles Management Utility"
    else
        # Korrektur SC2059 für die Fehlermeldung
        printf '  %sdctl       → [FEHLT ODER NICHT AUSFÜHRBAR]%s\n' \
            "${DF_C_RED:-}" "${DF_C_RESET:-}"
    fi

    _t_row "dutop"    "Top 10 Platzfresser (aktuell)"
    _t_row "path"     "Formatierten \$PATH anzeigen"
    _t_row "myip"     "Lokale & Öffentliche IP prüfen"
    _t_row "au"       "APT Update (Quick)"
    _t_row "au-full"  "APT Update + ZFS Scrub (Monatlich)"

    echo ""
    myip
}
