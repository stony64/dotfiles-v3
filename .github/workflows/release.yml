# ------------------------------------------------------------------------------
# FILE:        .github/workflows/release.yml
# VERSION:     3.6.7
# DESCRIPTION: Auto GitHub Release from core.sh Version + Changelog
# AUTHOR:      Stony64 - Bash/Shell Dotfiles Framework
# CHANGES:     v3.6.7 - Version mismatch is now error (not warning)
# ------------------------------------------------------------------------------

name: "üè∑Ô∏è Create Release"

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Manual Version Override (e.g., 3.6.7)"
        required: false
        default: ""
      prerelease:
        description: "Mark as pre-release"
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  checks: read

jobs:
  # --- PRE-CHECKS (Optional QA before release) --------------------------------
  shellcheck:
    name: "üîç ShellCheck Validation"
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîç Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: "."
          severity: error
          ignore_paths: "node_modules test_sandbox"

  # --- RELEASE CREATION -------------------------------------------------------
  release:
    name: "üöÄ Publish Release"
    runs-on: ubuntu-latest
    needs: [shellcheck]
    if: always() # Run even if shellcheck fails

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üè∑Ô∏è Extract Version from core.sh
        id: meta
        shell: bash
        run: |
          # Parse DF_PROJECT_VERSION from core.sh (robust)
          RAW_VER=$(awk -F'"' '/^export DF_PROJECT_VERSION=/{print $2; exit}' core.sh 2>/dev/null || echo "")

          # Determine final version
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ -n "$RAW_VER" ]]; then
            VERSION="$RAW_VER"
          else
            # Fallback to tag name (strip 'v' prefix if present)
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          fi

          echo "DF_VER=$VERSION" >> "$GITHUB_OUTPUT"
          echo "TAG=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"

          echo "::notice::Code Version: $RAW_VER"
          echo "::notice::Final Version: $VERSION"
          echo "::notice::Git Tag: ${{ github.ref_name }}"

          # Version/Tag mismatch is now an ERROR (not warning)
          # Ensures releases only happen when code version matches tag
          if [[ "$RAW_VER" != "${{ github.ref_name }}"* && -n "$RAW_VER" ]]; then
            echo "::error::Version Mismatch! Code v$RAW_VER ‚â† Tag ${{ github.ref_name }}"
            echo "::error::Please update DF_PROJECT_VERSION in core.sh to match tag"
            exit 1
          fi

      - name: üìÑ Generate Changelog from CHANGELOG.md
        id: changelog
        if: steps.meta.outputs.DF_VER != ''
        shell: bash
        run: |
          VERSION="${{ steps.meta.outputs.DF_VER }}"

          # Extract section from CHANGELOG.md (between version headers)
          if [[ -f "CHANGELOG.md" ]]; then
            CHANGELOG_SECTION=$(sed -n "/## \\[$VERSION\\]/,/^## \\[/p" CHANGELOG.md | sed '1d;$d' | sed '/^$/d')

            if [[ -n "$CHANGELOG_SECTION" ]]; then
              {
                echo "changelog<<EOF"
                echo "$CHANGELOG_SECTION"
                echo "EOF"
              } >> "$GITHUB_OUTPUT"
              echo "::notice::Changelog extracted for v$VERSION"
            else
              echo "::warning::No changelog section found for v$VERSION"
            fi
          else
            echo "::warning::CHANGELOG.md not found"
          fi

      - name: üîç Check Previous Jobs Status
        id: qa_status
        if: always()
        run: |
          # Check if shellcheck job ran and get its result
          SHELLCHECK_STATUS="${{ needs.shellcheck.result || 'skipped' }}"

          if [[ "$SHELLCHECK_STATUS" == "success" ]]; then
            echo "shellcheck_icon=‚úÖ" >> "$GITHUB_OUTPUT"
          elif [[ "$SHELLCHECK_STATUS" == "failure" ]]; then
            echo "shellcheck_icon=‚ùå" >> "$GITHUB_OUTPUT"
          else
            echo "shellcheck_icon=‚è≠Ô∏è" >> "$GITHUB_OUTPUT"
          fi

      - name: üöÄ Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: "Dotfiles Framework v${{ steps.meta.outputs.DF_VER }}"
          body: |
            ## üõ†Ô∏è Dotfiles Framework v${{ steps.meta.outputs.DF_VER }}

            **Tag**: `${{ github.ref_name }}` | **Code Version**: `${{ steps.meta.outputs.DF_VER }}`

            ### ‚úÖ Quality Checks
            | Check | Status |
            |-------|--------|
            | ShellCheck | ${{ steps.qa_status.outputs.shellcheck_icon }} |
            | Framework Version | ‚úÖ |

            ### üì¶ Quick Install

            **Standard Installation (recommended):**
            ```bash
            sudo git clone --depth=1 https://github.com/${{ github.repository }} /opt/dotfiles
            cd /opt/dotfiles
            sudo ./dotfilesctl.sh install $USER
            source ~/.bashrc
            ```

            **Verify Installation:**
            ```bash
            dctl status      # Check symlink integrity
            dctl version     # Show framework version
            ```

            ### üìã Changelog
            ${{ steps.changelog.outputs.changelog || '*(No changelog available - see CHANGELOG.md)*' }}

            ### üîó Downloads & Assets
            - üìÑ [dotfilesctl.sh](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/dotfilesctl.sh) - Main installer
            - üìÑ [core.sh](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/core.sh) - Framework library
            - üìö [Documentation](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md)
            - üì¶ [Source Code (zip)](https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.ref_name }}.zip)
            - üì¶ [Source Code (tar.gz)](https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.ref_name }}.tar.gz)

            ### üõ†Ô∏è Requirements
            - **OS**: Debian 11+, Ubuntu 20.04+, Proxmox VE 7+
            - **Shell**: Bash 4.4+
            - **Root Access**: Required for system-wide installation

            ---
            *Release automatically generated from [core.sh](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/core.sh) version*
          generate_release_notes: false # Use custom changelog
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' || contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}

      - name: üìä Release Summary
        if: always()
        run: |
          echo "### üéâ Release Published!"
          echo ""
          echo "**Version:** v${{ steps.meta.outputs.DF_VER }}"
          echo "**Tag:** \`${{ github.ref_name }}\`"
          echo "**Status:** ${{ job.status }}"
          echo ""
          echo "#### üîó Links"
          echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})"
          echo "- [View Code](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }})"
          echo "- [Compare Changes](https://github.com/${{ github.repository }}/compare/$(git describe --tags --abbrev=0 ${{ github.ref_name }}^)...${{ github.ref_name }})"
          echo ""
          echo "#### üì¶ Quick Install Command"
          echo "\`\`\`bash"
          echo "sudo git clone --depth=1 https://github.com/${{ github.repository }} /opt/dotfiles && sudo /opt/dotfiles/dotfilesctl.sh install \$USER"
          echo "\`\`\`"
