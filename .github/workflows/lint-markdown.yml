# ------------------------------------------------------------------------------
# FILE:        .github/workflows/lint-markdown.yml
# VERSION:     3.6.8 (FIXED)
# DESCRIPTION: GitHub Action: Markdown Linting with SARIF Annotations
# AUTHOR:      Stony64 - Bash/Shell Dotfiles Framework
# CHANGES:     3.6.8 - Fix SARIF upload, update to CodeQL v4, add security-events
# ------------------------------------------------------------------------------

name: "üìù Lint Markdown"

on:
  push:
    branches: [main, master, "release/**"]
    paths:
      - "**/*.md"
      - ".markdownlint*"
      - ".github/workflows/lint-markdown.yml"
  pull_request:
    branches: [main, master]
    paths:
      - "**/*.md"
      - ".markdownlint*"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ‚úÖ FIXED: Added security-events: write
permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write # ‚Üê WICHTIG: Hinzugef√ºgt!

jobs:
  markdownlint:
    name: "üîç Markdown Linting"
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üîç Run markdownlint-cli2
        uses: DavidAnson/markdownlint-cli2-action@v20
        with:
          config: .markdownlint-cli2.jsonc
          globs: |
            **/*.md
            !node_modules
            !.git
            !**/_exports/**
            !**/test_sandbox/**
            !home/**
          fix: false
        continue-on-error: true # ‚Üê WICHTIG: Nicht bei Linting-Fehler abbrechen

      # ‚úÖ FIXED: Conditional upload + v4
      - name: üìä Upload SARIF (Annotations)
        if: always() && hashFiles('markdownlint-cli2.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4 # ‚Üê v4 statt v3!
        with:
          sarif_file: markdownlint-cli2.sarif
          checkout_path: ${{ github.workspace }}
        continue-on-error: true # ‚Üê WICHTIG: Graceful fallback

      - name: üìù Job Summary
        if: always()
        run: |
          echo "### Markdown Linting Status: ${{ job.status }}"
          echo ""

          if [[ "${{ job.status }}" == "success" ]]; then
            echo "‚úÖ **All Markdown files** comply with project style"
            echo "**Files checked:** $(find . -name '*.md' -not -path '*/node_modules/*' -not -path '*/.git/*' -not -path '*/home/*' | wc -l)"
            echo "**Config:** [.markdownlint-cli2.jsonc](.markdownlint-cli2.jsonc)"
            echo "**Rules:** MD001, MD003=atx_closed, MD013=off, MD024=siblings_only"
          else
            echo "‚ùå **Linting errors found** ‚Üí Check **Annotations** tab!"
            echo "**Fix locally:** \`markdownlint-cli2 --fix \"**/*.md\"\`"
            echo "**Config:** [.markdownlint-cli2.jsonc](.markdownlint-cli2.jsonc)"
          fi

          echo ""
          echo "---"
          echo "*Triggered:* ${{ github.event_name }} #${{ github.run_number }}"
          echo "*Branch:* ${{ github.ref_name }}"
          echo "*Commit:* ${{ github.sha }}"
        shell: bash
