# ------------------------------------------------------------------------------
# FILE:        .github/workflows/lint-markdown.yml
# VERSION:     1.3.1
# DESCRIPTION: GitHub Action: Markdown Linting mit SARIF Annotations
# AUTHOR:      Stony64 - Proxmox/Debian Dotfiles Framework
# ------------------------------------------------------------------------------

name: "üìù Lint Markdown"

on:
  push:
    branches: [main, master, "release/**"]
    paths:
      - "**/*.md"
      - ".markdownlint*"
      - "markdownlint-cli2.jsonc"
      - ".github/workflows/lint-markdown.yml"
  pull_request:
    branches: [main, master]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write # SARIF Upload

jobs:
  markdownlint:
    name: "üîç Markdown Linting"
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Full history for changelog

      - name: üîç Run markdownlint-cli2
        uses: DavidAnson/markdownlint-cli2-action@v19.1.2
        with:
          config_file: markdownlint-cli2.jsonc
          globs: |
            **/*.md
            README.md
            STYLEGUIDE.md
            CHANGELOG.md
          globs_exclude: |
            **/_exports/**
            **/test_sandbox/**
            home/**
        continue-on-error: false

      - name: üìä Upload SARIF (Annotations)
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: report.sarif
          checkout_path: ${{ github.workspace }}

      - name: üìù Job Summary
        if: always()
        run: |
          echo "### Markdown Linting Status: ${{ job.status }}"

          if [[ "${{ job.status }}" == "success" ]]; then
            echo ""
            echo "‚úÖ **All Markdown files** comply with Style Guide v1.4.2"
            echo "**Files checked:** $(find . -name '*.md' | wc -l)"
            echo "**Config:** [markdownlint-cli2.jsonc](markdownlint-cli2.jsonc)"
            echo "**Rules:** MD001=true, MD003=atx_closed, MD013=off (tables)"
          else
            echo ""
            echo "‚ùå **Linting errors** found ‚Üí Check **Annotations**!"
            echo "**Fix:** Files changed tab (red highlights)"
            echo "**Config:** [markdownlint-cli2.jsonc](markdownlint-cli2.jsonc)"
          fi

          echo ""
          echo "---"
          echo "*Triggered:* ${{ github.event_name }} #${{ github.run_number }}"
          echo "*Branch:* ${{ github.ref_name }}"
        shell: bash
